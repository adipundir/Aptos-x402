# ARC-8004 Agent Trust Layer (Aptos)

## Overview

ARC-8004 brings agent identity, reputation, and validation to Aptos, inspired by ERC-8004. It integrates tightly with x402 payments so every paid interaction can feed trust signals.

**Modules (testnet deployment):**
- Identity: `4d7a87c0032df24b6bb29424d1ab3e7dffa5ca6801382523883f38485c32555f::agent_identity`
- Reputation: `4d7a87c0032df24b6bb29424d1ab3e7dffa5ca6801382523883f38485c32555f::reputation`
- Validation: `4d7a87c0032df24b6bb29424d1ab3e7dffa5ca6801382523883f38485c32555f::validation`

**Deployment TXs (testnet):**
- Publish: `0x75f5d9e7b22e4125dea6e96d58163929ee3641026d50dcca1619cf1f96567479`
- Init identity: `0xa67bc9d88bb83c099e4daf04704362882aa91a77227e38b096640b11e6d6e46e`
- Init reputation: `0xf6542dbe71b5c14877e05cdefe8f028a07a9e058b9f20244d14f24b85b61ea77`
- Init validation: `0x3198bac03d21a1bc0d6aef4681a4cc4d23636fa97333983e4d5e1e0cd957dcba`

## Environment

Add to `.env.local` (already in `.env.example`):
```
ARC8004_MODULE_ADDRESS=4d7a87c0032df24b6bb29424d1ab3e7dffa5ca6801382523883f38485c32555f
ARC8004_AUTO_REGISTER=true
ARC8004_ONCHAIN_ENABLED=false   # set true only when you want on-chain attestations
```

## Server SDK (combined with aptos-x402)

Install (already part of the repo):
```
npm install aptos-x402
```
Key classes:
- `IdentityRegistry` – register/resolve identities
- `ReputationRegistry` – submit feedback, get trust scores
- `ValidationRegistry` – submit/verify task validations

Example: register identity (server)
```ts
import { IdentityRegistry, createAgentCard } from 'aptos-x402';

const registry = new IdentityRegistry({ network: 'testnet' });
await registry.registerIdentity({
  agentId: 'agent_123',
  agentCard: createAgentCard({
    name: 'WeatherBot',
    description: 'Fetches weather',
    ownerAddress: '0x...',
    ownerPublicKey: '0x...',
    capabilities: ['payment', 'data-fetch'],
    protocols: ['x402', 'http'],
    supportedNetworks: ['aptos-testnet'],
  }),
});
```

Example: submit feedback (after x402 payment)
```ts
import { ReputationRegistry } from 'aptos-x402';
const rep = new ReputationRegistry({ network: 'testnet' });
await rep.submitFeedback({
  agentId: 'agent_123',
  clientAddress: '0xclient',
  overallScore: 5,
  paymentHash: '0xPAYMENT_TX',
  paymentAmount: '1000000',
  tags: ['automated', 'x402'],
});
```

Example: verify validation before releasing payment
```ts
import { ValidationRegistry } from 'aptos-x402';
const val = new ValidationRegistry({ network: 'testnet' });
const result = await val.verifyTaskForPayment('task-1', 'agent_123');
if (!result.isValid) throw new Error('Task not validated');
```

## HTTP APIs (Next.js app)
- `GET /api/arc8004/identity?agentId=...`
- `POST /api/arc8004/identity` (register)
- `PATCH /api/arc8004/identity` (update card)
- `GET /api/arc8004/reputation?agentId=...&includeHistory=true`
- `POST /api/arc8004/reputation/feedback` (submit feedback)
- `GET /api/arc8004/reputation/feedback?agentId=...`
- `GET /api/arc8004/validation?taskId=...` (or validationId/agentId)
- `POST /api/arc8004/validation` (submit validation)
- `PATCH /api/arc8004/validation` (approve/reject)

## Frontend integration tips
- Show identity status: call `/api/arc8004/identity?agentId=...` and display `verified`, `agentCard` details.
- Show trust badges: use `trustLevel` and `trustLevelColor` from reputation API.
- After a paid call, POST to `/api/arc8004/reputation/feedback` with `paymentHash` from x402 response.
- Before releasing funds/confirming actions, check validation via `/api/arc8004/validation`.

## How others can adopt
- Use `aptos-x402` directly (single SDK) for both payments and trust.
- If they only want trust: still install `aptos-x402` and use ARC-8004 classes; payments are optional.
- To deploy their own contracts: publish the Move package, set `ARC8004_MODULE_ADDRESS` to their address, and flip `ARC8004_ONCHAIN_ENABLED=true` as needed.

## Notes

- On-chain steps are optional; set `ARC8004_ONCHAIN_ENABLED=true` only if requiring attestations.\n- Auto-registration is enabled by default when creating agents; set `ARC8004_AUTO_REGISTER=false` to opt out.\n- Reputation and validation write to Neon DB; keep migrations in sync.