# ARC-8004 Agent Trust Layer (Aptos)

## Overview

ARC-8004 brings agent identity, reputation, and validation to Aptos, inspired by ERC-8004. It integrates tightly with x402 payments so every paid interaction can feed trust signals.

**Modules (testnet deployment):**
- Identity: `0xa4d7e1f47887dc6b84743297164fdd63deaa872329f8617be1d4c87375d39323::agent_identity`
- Reputation: `0xa4d7e1f47887dc6b84743297164fdd63deaa872329f8617be1d4c87375d39323::reputation`
- Validation: `0xa4d7e1f47887dc6b84743297164fdd63deaa872329f8617be1d4c87375d39323::validation`

**Deployment TXs (testnet):**
- Publish: `0x75f5d9e7b22e4125dea6e96d58163929ee3641026d50dcca1619cf1f96567479`
- Init identity: `0xa67bc9d88bb83c099e4daf04704362882aa91a77227e38b096640b11e6d6e46e`
- Init reputation: `0xf6542dbe71b5c14877e05cdefe8f028a07a9e058b9f20244d14f24b85b61ea77`
- Init validation: `0x3198bac03d21a1bc0d6aef4681a4cc4d23636fa97333983e4d5e1e0cd957dcba`

## Environment

Add to `.env.local` (already in `.env.example`):
```
ARC8004_MODULE_ADDRESS=0xa4d7e1f47887dc6b84743297164fdd63deaa872329f8617be1d4c87375d39323
ARC8004_AUTO_REGISTER=true
ARC8004_ONCHAIN_ENABLED=false   # set true only when you want on-chain attestations
```

## Server SDK (combined with aptos-x402)

Install (already part of the repo):
```
npm install aptos-x402
```
Key classes:
- `IdentityRegistry` ‚Äì register/resolve identities
- `ReputationRegistry` ‚Äì submit feedback, get trust scores
- `ValidationRegistry` ‚Äì submit/verify task validations

Example: register identity (server)
```ts
import { IdentityRegistry, createAgentCard } from 'aptos-x402';

const registry = new IdentityRegistry({ network: 'testnet' });
await registry.registerIdentity({
  agentId: 'agent_123',
  agentCard: createAgentCard({
    name: 'WeatherBot',
    description: 'Fetches weather',
    ownerAddress: '0x...',
    ownerPublicKey: '0x...',
    capabilities: ['payment', 'data-fetch'],
    protocols: ['x402', 'http'],
    supportedNetworks: ['aptos-testnet'],
  }),
});
```

Example: submit feedback (after x402 payment)
```ts
import { ReputationRegistry } from 'aptos-x402';
const rep = new ReputationRegistry({ network: 'testnet' });
await rep.submitFeedback({
  agentId: 'agent_123',
  clientAddress: '0xclient',
  overallScore: 5,
  paymentHash: '0xPAYMENT_TX',
  paymentAmount: '1000000',
  tags: ['automated', 'x402'],
});
```

Example: verify validation before releasing payment
```ts
import { ValidationRegistry } from 'aptos-x402';
const val = new ValidationRegistry({ network: 'testnet' });
const result = await val.verifyTaskForPayment('task-1', 'agent_123');
if (!result.isValid) throw new Error('Task not validated');
```

## HTTP APIs (Next.js app)
- `GET /api/arc8004/identity?agentId=...`
- `POST /api/arc8004/identity` (register)
- `PATCH /api/arc8004/identity` (update card)
- `GET /api/arc8004/reputation?agentId=...&includeHistory=true`
- `POST /api/arc8004/reputation/feedback` (submit feedback)
- `GET /api/arc8004/reputation/feedback?agentId=...`
- `GET /api/arc8004/validation?taskId=...` (or validationId/agentId)
- `POST /api/arc8004/validation` (submit validation)
- `PATCH /api/arc8004/validation` (approve/reject)

## Frontend integration tips
- Show identity status: call `/api/arc8004/identity?agentId=...` and display `verified`, `agentCard` details.
- Show trust badges: use `trustLevel` and `trustLevelColor` from reputation API.
- After a paid call, POST to `/api/arc8004/reputation/feedback` with `paymentHash` from x402 response.
- Before releasing funds/confirming actions, check validation via `/api/arc8004/validation`.

## Agent Verification (Admin-Only)

On-chain agent verification is an **admin-only operation**. This is by design in the Move smart contract.

**Important: Most ARC-8004 features work without on-chain verification**:
- ‚úÖ Identity registration (DB)
- ‚úÖ Agent Cards with metadata
- ‚úÖ Reputation scores and feedback
- ‚úÖ Task validation
- ‚ùå On-chain NFT minting (requires `ARC8004_ONCHAIN_ENABLED=true`)
- ‚ùå On-chain verification badge (requires admin)

**For most use cases, you don't need on-chain verification. The DB-based identity and reputation system provides:**
- Agent identity tracking
- Trust scores from feedback
- Task validation workflows
- All queryable via SDK/API

**Why admin-only verification?**
- Ensures trusted verification authority
- Prevents spam/fake verifications
- Maintains integrity of the trust layer
- Enables platform-level quality control

## Using ARC-8004 in Your App

### Option 1: DB-Only Mode (Recommended for Most Users)

This is the simplest approach - no blockchain deployment needed:

```bash
# .env.local
ARC8004_AUTO_REGISTER=true
ARC8004_ONCHAIN_ENABLED=false  # Default - no on-chain required
```

```typescript
import { IdentityRegistry, ReputationRegistry, createAgentCard } from 'aptos-x402';

// Register agent identity (stored in your DB)
const registry = new IdentityRegistry();
await registry.registerIdentity({
  agentId: 'my-agent',
  agentCard: createAgentCard({
    name: 'MyBot',
    description: 'Does useful things',
    ownerAddress: '0x...',
    ownerPublicKey: '0x...',
    capabilities: ['payment', 'data-fetch'],
  }),
});

// Track reputation
const rep = new ReputationRegistry();
await rep.submitFeedback({
  agentId: 'my-agent',
  clientAddress: '0xclient',
  overallScore: 5,
  paymentHash: '0xPAYMENT_TX',
});

// Get trust score
const score = await rep.getReputation('my-agent');
console.log(score.trustLevel); // "GOOD", "EXCELLENT", etc.
```

### Option 2: Use Shared Testnet Contracts

Point to the existing Aptos-x402 testnet deployment:

```bash
# .env.local  
ARC8004_MODULE_ADDRESS=0xa4d7e1f47887dc6b84743297164fdd63deaa872329f8617be1d4c87375d39323
ARC8004_ONCHAIN_ENABLED=true
ARC8004_AUTO_REGISTER=true
```

This enables on-chain NFT minting for agent identities, but **verification is still admin-only** (controlled by Aptos-x402 platform).

### Option 3: Self-Hosted Contracts (Advanced)

For full control over verification, you can deploy your own ARC-8004 contracts. This requires:
- Aptos CLI knowledge
- Move contract deployment experience
- Managing your own admin keys

The contracts are available in the [Aptos-x402 GitHub repository](https://github.com/adipundir/Aptos-x402) under `contracts/arc8004/`.

üëâ **See: [ARC-8004 Self-Hosting Guide](/docs/guides/arc8004-self-hosting)**

## How others can adopt

**Recommended approach for most users:**
```bash
npm install aptos-x402
```

```typescript
import { IdentityRegistry, ReputationRegistry } from 'aptos-x402';

// That's it! Works with your existing database.
// No blockchain deployment required.
```

**Summary of options:**
1. **DB-only mode** (recommended) - All trust features, no blockchain setup
2. **Shared contracts** - Add on-chain NFTs, but verification is platform-controlled  
3. **Self-hosted** - Full control, but requires Move contract deployment

## Notes

- On-chain steps are optional; set `ARC8004_ONCHAIN_ENABLED=true` only if requiring attestations.
- Auto-registration is enabled by default when creating agents; set `ARC8004_AUTO_REGISTER=false` to opt out.
- Reputation and validation write to Neon DB; keep migrations in sync.
- For self-hosted deployments, **keep your admin private key secure** - it controls all verification authority.